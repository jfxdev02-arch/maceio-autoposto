services:
  # PostgreSQL - App Database
  postgres:
    image: postgres:15-alpine
    container_name: maceio-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: maceio
      POSTGRES_PASSWORD: maceio2024
      POSTGRES_DB: maceio_autoposto
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - maceio-network
    expose:
      - "5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U maceio -d maceio_autoposto"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s

  # PostgreSQL - Evolution API Database
  evolution-postgres:
    image: postgres:15-alpine
    container_name: maceio-evolution-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: evolution
      POSTGRES_USER: evolution
      POSTGRES_PASSWORD: evolution-segura-123
    volumes:
      - evolution_postgres_data:/var/lib/postgresql/data
    networks:
      - maceio-network
    expose:
      - "5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U evolution -d evolution"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s

  # Redis for Evolution API
  evolution-redis:
    image: redis:7-alpine
    container_name: maceio-evolution-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - evolution_redis:/data
    networks:
      - maceio-network
    expose:
      - "6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s

  # Evolution API
  evolution:
    image: evoapicloud/evolution-api:homolog
    container_name: maceio-evolution
    restart: unless-stopped
    depends_on:
      evolution-postgres:
        condition: service_healthy
      evolution-redis:
        condition: service_healthy
    ports:
      - "8080:8080"
    volumes:
      - evolution_instances:/evolution/instances
    networks:
      - maceio-network
    environment:
      - SERVER_URL=http://76.13.225.52:8080
      - AUTHENTICATION_API_KEY=maceio-autoposto-key-2024
      - DATABASE_ENABLED=true
      - DATABASE_PROVIDER=postgresql
      - DATABASE_CONNECTION_URI=postgresql://evolution:evolution-segura-123@evolution-postgres:5432/evolution
      - REDIS_ENABLED=true
      - REDIS_URI=redis://evolution-redis:6379
      - CACHE_REDIS_ENABLED=true
      - CACHE_REDIS_URI=redis://evolution-redis:6379
      - LOG_LEVEL=ERROR
      - LOG_COLOR=true

  # Bot Service (Revertido para Evolution)
  bot:
    build:
      context: ./bot
      dockerfile: Dockerfile
    container_name: maceio-bot
    restart: unless-stopped
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:5000
      - ConnectionStrings__DefaultConnection=Host=postgres;Database=maceio_autoposto;Username=maceio;Password=maceio2024
      - EvolutionApi__BaseUrl=http://evolution:8080
      - EvolutionApi__ApiKey=maceio-autoposto-key-2024
      - EvolutionApi__InstanceName=MaceioAutoPosto
    ports:
      - "5000:5000"
    depends_on:
      postgres:
        condition: service_healthy
      evolution:
        condition: service_started
    networks:
      - maceio-network

  # Web Service
  web:
    build:
      context: ./web
      dockerfile: Dockerfile
    container_name: maceio-web
    restart: unless-stopped
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:5001
      - ConnectionStrings__DefaultConnection=Host=postgres;Database=maceio_autoposto;Username=maceio;Password=maceio2024
    ports:
      - "5001:5001"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - maceio-network

volumes:
  postgres_data:
  evolution_postgres_data:
  evolution_redis:
  evolution_instances:

networks:
  maceio-network:
    driver: bridge
